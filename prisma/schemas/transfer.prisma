// prisma/schemas/transfer.prisma
// ===== TRANSFER SYSTEM - Department to Department =====
// ✅ UPDATED: Match UI Types 100%

// ===== TRANSFER REQUEST (Organization Level) =====
model Transfer {
  id             String   @id @default(cuid())
  organizationId String
  
  // Transfer Reference
  code           String   // ✅ CHANGED: transferCode → code (match UI)
  title          String   // "ขอเบิกยาฉุกเฉิน OPD"
  
  // Department Context
  requestingDepartmentId String  // หน่วยงานที่ขอเบิก (destination)
  supplyingDepartmentId  String  // หน่วยงานที่จ่าย (source)
  
  // Request Info
  requestReason  String?  // เหตุผลในการขอเบิก
  notes          String?  // หมายเหตุเพิ่มเติม
  priority       TransferPriority @default(NORMAL)
  
  // ✅ CHANGED: Transfer-Level Status (เก็บทั้ง UI และ computed)
  status         TransferStatus @default(PENDING)  // UI status (includes APPROVED/PREPARED/DELIVERED)
  
  // Timeline
  requestedAt    DateTime  @default(now())
  approvedAt     DateTime?
  preparedAt     DateTime?  // ✅ ADDED: For UI timeline
  deliveredAt    DateTime?  // ✅ ADDED: For UI timeline
  cancelledAt    DateTime?
  
  // Cancellation
  cancelReason   String?
  
  // User Tracking
  requestedBy         String
  requestedBySnapshot Json?
  
  // ✅ REMOVED: approvedBy, cancelledBy (ไม่จำเป็นใน transfer level)
  
  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestingDepartment Department  @relation("TransferRequesting", fields: [requestingDepartmentId], references: [id], onDelete: Restrict)
  supplyingDepartment  Department  @relation("TransferSupplying", fields: [supplyingDepartmentId], references: [id], onDelete: Restrict)
  
  items          TransferItem[]
  statusHistory  TransferHistory[]
  
  // Indexes
  @@unique([organizationId, code])
  @@index([organizationId, status])
  @@index([requestingDepartmentId, status])
  @@index([supplyingDepartmentId, status])
  @@index([requestedAt])
  @@index([status, priority])
  @@map("transfers")
}

// ===== TRANSFER ITEMS (Item-Level Status) =====
model TransferItem {
  id             String   @id @default(cuid())
  transferId     String
  
  // ✅ CHANGED: Product Info (ไม่ต้องเก็บ snapshot ซ้ำ - join กับ Product table)
  productId      String
  
  // Item-Level Status
  status         TransferItemStatus @default(PENDING)
  
  // Quantity Tracking
  requestedQuantity Int
  approvedQuantity  Int?
  preparedQuantity  Int?
  receivedQuantity  Int?
  
  // Notes
  notes          String?
  cancelReason   String?  // ✅ CHANGED: rejectReason → cancelReason (match UI)
  
  // Timeline
  approvedAt     DateTime?
  preparedAt     DateTime?
  deliveredAt    DateTime?
  cancelledAt    DateTime?
  
  // ✅ REMOVED: User Tracking (ใช้ History แทน - avoid duplication)
  
  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  transfer       Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  product        Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  batches        TransferBatch[]  // ✅ ADDED: Separate table instead of JSON
  
  // Indexes
  @@index([transferId])
  @@index([productId])
  @@index([status])
  @@index([transferId, status])
  @@map("transfer_items")
}

// ===== TRANSFER BATCH (Batch Selection) =====
// ✅ ADDED: Separate table for batches (better than JSON)
model TransferBatch {
  id              String   @id @default(cuid())
  transferItemId  String
  batchId         String
  quantity        Int      // จำนวนที่จัดเตรียม
  receivedQuantity Int?    // ✅ NEW: จำนวนที่รับเข้าจริง
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  // Relations
  transferItem    TransferItem @relation(fields: [transferItemId], references: [id], onDelete: Cascade)
  batch           StockBatch   @relation(fields: [batchId], references: [id], onDelete: Restrict)
  
  // Indexes
  @@index([transferItemId])
  @@index([batchId])
  @@map("transfer_batches")
}

// ===== TRANSFER HISTORY (Audit Trail) =====
// ✅ CHANGED: Rename to match UI types
model TransferHistory {
  id             String   @id @default(cuid())
  transferId     String
  itemId         String?  // สำหรับ item-level actions
  
  // ✅ CHANGED: Action info (match UI types)
  action         String   // "APPROVED", "PREPARED", "DELIVERED", "CANCELLED"
  fromStatus     String?
  toStatus       String?
  
  // Who & Why
  changedBy         String
  changedBySnapshot Json?
  notes          String?
  
  // Timestamp
  createdAt      DateTime @default(now())
  
  // Relations
  transfer       Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([transferId, createdAt(sort: Desc)])
  @@index([itemId])
  @@map("transfer_histories")
}

// ===== ENUMS =====
// ✅ CHANGED: Match UI types exactly
enum TransferStatus {
  PENDING      // รอดำเนินการ
  APPROVED     // อนุมัติแล้ว (all items approved)
  PREPARED     // จัดเตรียมแล้ว (all items prepared)
  DELIVERED    // รับเข้าแล้ว (all items delivered)
  PARTIAL      // ดำเนินการบางส่วน
  COMPLETED    // เสร็จสมบูรณ์ (alias for DELIVERED)
  CANCELLED    // ยกเลิก
}

enum TransferItemStatus {
  PENDING      // รอการอนุมัติ
  APPROVED     // อนุมัติแล้ว
  PREPARED     // จัดเตรียมแล้ว
  DELIVERED    // รับเข้าแล้ว
  CANCELLED    // ยกเลิก
}

enum TransferPriority {
  NORMAL       // ปกติ
  URGENT       // ด่วน
  CRITICAL     // ด่วนมาก
}